#! /bin/bash -e

export DISPLAY=:99
Xvfb :99 > /dev/null 2>&1 &

# $1 == repo url
# $2 == repo revision
task="run_task.sh"

# git url (https://github.com/...)
repo=$1
# revision (like master)
rev=$2
repo_dir='git_checkout';
# rest args take everything else and pass its as the cmd
cmd=${@:3:999}
echo $cmd

# mostly so we can re-run tasks manually
rm -f $task
rm -Rf $repo_dir;

echo "#! /bin/bash -ve" >> $task
echo "git clone $repo $repo_dir" >> $task
echo "cd $repo_dir" >> $task
echo "git checkout $rev" >> $task

# command
echo "$cmd" >> $task

chmod u+x $task
./$task
exit $?
