#! /bin/bash -vx

checkout_path="$PWD/git_checkout"

# update to a particular commit in a branch
github_branch() {
  # fetch the reference from github
  git fetch origin $1
  # then update to the tip of that reference
  git checkout -qf $2
}

# update to a pull request
github_pullrequest() {
  # fetch the reference from github
  git fetch --depth 1 origin +refs/pulls/$1/merge
  # then update to the tip of that reference
  git checkout -qf FETCH_HEAD
}

# move to the cached repo checkout
cd $checkout_path

# figure out which type of request this is then update the cached git repo
if [ "$GH_PULL_REQUEST" == "true" ]
then
  github_pullrequest $GH_PULL_REQUEST_NUMBER
else
  github_branch $GH_BRANCH $GH_COMMIT;
fi

# run whatever command was intended on the branch (root of the repo)
eval $@
